# Run:ai v2.24 Helm Installation Reference

## Chart Repositories

- **Control Plane**: `helm repo add runai-backend https://runai.jfrog.io/artifactory/cp-charts-prod`
- **Cluster**: Dynamically provided via UI wizard (connected) or local `.tgz` (airgapped)
- **Airgapped packages**: `https://runai.jfrog.io/artifactory/runai-airgapped-prod/`

## Two-Phase Installation

Run:ai self-hosted requires two separate Helm installs:
1. **Control Plane** (`runai-backend` chart in `runai-backend` namespace)
2. **Cluster Agent** (`runai-cluster` chart in `runai` namespace)

---

## Control Plane Installation

### Kubernetes - Connected
```bash
helm repo add runai-backend https://runai.jfrog.io/artifactory/cp-charts-prod
helm repo update
helm upgrade -i runai-backend -n runai-backend runai-backend/control-plane \
    --set global.domain=<DOMAIN> \
    --set global.ingress.ingressClass=haproxy \
    --set tenantsManager.config.adminUsername=<ADMIN_EMAIL> \
    --set tenantsManager.config.adminPassword="<ADMIN_PASSWORD>"
```

### Kubernetes - Airgapped
```bash
helm upgrade -i runai-backend control-plane-<VERSION>.tgz \
    --set global.domain=<DOMAIN> \
    --set global.customCA.enabled=true \
    --set tenantsManager.config.adminUsername=<ADMIN_EMAIL> \
    --set tenantsManager.config.adminPassword="<ADMIN_PASSWORD>" \
    -n runai-backend -f custom-env.yaml
```

### OpenShift - Connected
```bash
helm repo add runai-backend https://runai.jfrog.io/artifactory/cp-charts-prod
helm repo update
helm upgrade -i runai-backend -n runai-backend runai-backend/control-plane \
    --set global.domain=runai.apps.<OPENSHIFT-CLUSTER-DOMAIN> \
    --set global.config.kubernetesDistribution=openshift \
    --set tenantsManager.config.adminUsername=<ADMIN_EMAIL> \
    --set tenantsManager.config.adminPassword="<ADMIN_PASSWORD>"
```

### OpenShift - Airgapped
```bash
helm upgrade -i runai-backend ./control-plane-<VERSION>.tgz -n runai-backend \
    --set global.domain=runai.apps.<OPENSHIFT-CLUSTER-DOMAIN> \
    --set global.config.kubernetesDistribution=openshift \
    --set global.customCA.enabled=true \
    --set tenantsManager.config.adminUsername=<ADMIN_EMAIL> \
    --set tenantsManager.config.adminPassword="<ADMIN_PASSWORD>" \
    -f custom-env.yaml
```

### Control Plane Helm Values

| Flag | Description |
|------|-------------|
| `global.domain` | FQDN for the control plane |
| `global.ingress.ingressClass` | Ingress controller class (haproxy/nginx) |
| `global.config.kubernetesDistribution` | Set to `openshift` for OpenShift |
| `global.customCA.enabled` | Enable custom CA trust (airgapped) |
| `tenantsManager.config.adminUsername` | Initial admin email |
| `tenantsManager.config.adminPassword` | Initial admin password (8+ chars, 1 digit, 1 lower, 1 upper, 1 special) |

---

## Cluster Installation

### Airgapped (Kubernetes & OpenShift)
```bash
helm upgrade -i runai-cluster runai-cluster-<VERSION>.tgz \
    --set controlPlane.url=... \
    --set controlPlane.clientSecret=... \
    --set cluster.uid=... \
    --set cluster.url=... --create-namespace \
    --set global.image.registry=registry.mycompany.local \
    --set clusterConfig.prometheus.spec.baseImage=registry.mycompany.local/prometheus/prometheus \
    --set global.customCA.enabled=true
```

### Connected
Commands are dynamically generated by the Run:ai UI cluster creation wizard. Same `--set` flags but without `global.image.registry` and `global.customCA.enabled`.

### Cluster Helm Values

| Flag | Description |
|------|-------------|
| `controlPlane.url` | URL of the control plane |
| `controlPlane.clientSecret` | Client secret from UI wizard |
| `cluster.uid` | Cluster UID from UI wizard |
| `cluster.url` | Cluster endpoint URL |
| `global.image.registry` | Private registry (airgapped) |
| `clusterConfig.prometheus.spec.baseImage` | Prometheus image in private registry |
| `global.customCA.enabled` | Enable custom CA trust |

---

## Upgrade

### Control Plane Upgrade
```bash
helm get values runai-backend -n runai-backend > runai_control_plane_values.yaml
helm upgrade runai-backend -n runai-backend runai-backend/control-plane \
    --version "<VERSION>" -f runai_control_plane_values.yaml --reset-then-reuse-values
```

### Upgrade Order
1. Control plane FIRST
2. Cluster SECOND

---

## Uninstall

```bash
helm uninstall runai-backend -n runai-backend   # Control plane
helm uninstall runai-cluster -n runai              # Cluster
```

Note: Uninstall does NOT delete existing projects, departments, or workloads.

---

## Preparations

### Image Pull Secret (Connected)
```bash
kubectl create secret docker-registry runai-reg-creds \
    --docker-server=https://runai.jfrog.io \
    --docker-username=self-hosted-image-puller-prod \
    --docker-password=<TOKEN> \
    --docker-email=support@run.ai \
    --namespace=runai-backend
```

### Airgapped Package Download
```bash
curl -H "Authorization: Bearer <token>" \
    "https://runai.jfrog.io/artifactory/api/storage/runai-airgapped-prod/?list"
curl -L -H "Authorization: Bearer <token>" -O \
    "https://runai.jfrog.io/artifactory/runai-airgapped-prod/runai-airgapped-package-<VERSION>.tar.gz"
tar xvf runai-airgapped-package-<VERSION>.tar.gz
export REGISTRY_URL=<DOCKER_REGISTRY_ADDRESS>
sudo ./setup.sh    # pushes images, generates custom-env.yaml
```

### External PostgreSQL Setup
```sql
CREATE DATABASE <DATABASE_NAME>;
CREATE ROLE <ROLE_NAME> WITH LOGIN PASSWORD '<ROLE_PASSWORD>';
GRANT ALL PRIVILEGES ON DATABASE <DATABASE_NAME> TO <ROLE_NAME>;
\c <DATABASE_NAME>
CREATE ROLE grafana WITH LOGIN PASSWORD '<GRAFANA_PASSWORD>';
CREATE SCHEMA grafana authorization grafana;
ALTER USER grafana set search_path='grafana';
```

---

## Key Architecture Facts

- Control plane namespace: `runai-backend`
- Cluster namespace: `runai`
- Helm 3.14+ required
- External dependencies: PostgreSQL 16+ (optional, included by default), Keycloak (included)
- Ingress: HAProxy recommended (v2.24+), nginx also supported
- TLS: Required, secret named `runai-backend-tls`
- FQDN required (not IP address)
